{% extends 'base.html' %}
{% block title %}Products{% endblock %}

{% block content %}
    <div class="container mx-auto p-4">
        <!-- Main Canvas with A4 Aspect Ratio (1:1.414) -->
        <div id="mainImageContainer" class="relative max-w-[300px] w-full mx-auto" style="aspect-ratio: 1 / 1.414;">

                <div class="">
                {% if products %}
                    <img id="mainImage" 
                        src="{{ products[0].imageUrl }}" 
                        alt="Product Image" 
                        class="w-full h-full object-cover rounded-lg shadow-md cursor-pointer"
                        onclick="openModal(currentIndex)">
                {% else %}
                    <p class="text-center text-gray-500">No products available.</p>
                {% endif %}
                </div>

                <!-- Navigation Arrows -->
                <button id="prevBtn" 
                        class="absolute left-2 top-1/2 -translate-y-1/2 bg-black/50 text-white p-2 rounded-full z-10 hover:bg-black/75 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <button id="nextBtn" 
                        class="absolute right-2 top-1/2 -translate-y-1/2 bg-black/50 text-white p-2 rounded-full z-10 hover:bg-black/75 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
        </div>

        <!-- Product Details -->
        <div id="productDetails" class="text-center mt-4">
            {% if products %}
                <p id="productId" class="text-sm sm:text-base text-gray-600">ID: {{ products[0].id }}</p>
                <p id="productPrice" class="text-lg sm:text-xl font-bold text-blue-600">{{ products[0].price }}</p>
            {% else %}
                <p class="text-center text-gray-500">No product details available.</p>
            {% endif %}
        </div>

        <!-- Listing Canvas (Thumbnails) -->
        <div class="w-full relative overflow-hidden mt-4">
            <div id="thumbnailContainer" class="flex justify-center items-center space-x-2 w-full px-2">
                {% if products %}
                    {% for product in products %}
                    <div class="flex-shrink-0 w-16 h-16 md:w-20 md:h-20 lg:w-24 lg:h-24">
                        <img src="{{ product.imageUrl }}" 
                             class="w-full h-full cursor-pointer rounded-lg object-cover {% if loop.index0 == 0 %}ring-4 ring-blue-500 scale-110{% else %}opacity-60 hover:opacity-100{% endif %}"
                             onclick="changeImage({{ loop.index0 }})">
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-center text-gray-500">No thumbnails available.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Modal for Full Image Preview -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden">
        <span class="absolute top-4 right-4 text-white text-3xl cursor-pointer" onclick="closeModal()">&times;</span>
        <img id="modalImage" src="" alt="Full Preview" class="max-w-full max-h-screen object-contain">
    </div>
{% endblock %}

{% block scripts %}
<script>
    // Safely pass the products array from Jinja2 to JavaScript
    const products = {{ products | tojson | safe }};
    let currentIndex = 0;

    // Function to update the main image and details
    function changeImage(index) {
        if (!products || products.length === 0) return; // Exit if no products

        currentIndex = index;
        document.getElementById('mainImage').src = products[index].imageUrl;
        document.getElementById('productId').textContent = `ID: ${products[index].id}`;
        document.getElementById('productPrice').textContent = products[index].price;

        // Update thumbnail highlights
        const thumbnails = document.querySelectorAll('#thumbnailContainer img');
        thumbnails.forEach((thumb, i) => {
            thumb.classList.toggle('ring-4', i === index);
            thumb.classList.toggle('scale-110', i === index);
            thumb.classList.toggle('opacity-60', i !== index);
        });
    }

    // Open modal with full image preview
    function openModal(index) {
        if (!products || products.length === 0) return; // Exit if no products

        const modal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        modalImage.src = products[index].imageUrl;
        modal.classList.remove('hidden');
    }

    // Close modal
    function closeModal() {
        const modal = document.getElementById('imageModal');
        modal.classList.add('hidden');
    }

    // Previous button functionality
    document.getElementById('prevBtn')?.addEventListener('click', () => {
        if (!products || products.length === 0) return; // Exit if no products
        currentIndex = currentIndex === 0 ? products.length - 1 : currentIndex - 1;
        changeImage(currentIndex);
    });

    // Next button functionality
    document.getElementById('nextBtn')?.addEventListener('click', () => {
        if (!products || products.length === 0) return; // Exit if no products
        currentIndex = (currentIndex + 1) % products.length;
        changeImage(currentIndex);
    });

    // Optional: Handle touch gestures for mobile devices
    let startTouchX = 0;
    document.addEventListener('touchstart', (event) => {
        startTouchX = event.touches[0].clientX;
    });

    document.addEventListener('touchend', (event) => {
        if (!products || products.length === 0) return; // Exit if no products
        const endTouchX = event.changedTouches[0].clientX;
        if (startTouchX - endTouchX > 50) {
            // Swipe left -> Next
            document.getElementById('nextBtn').click();
        } else if (endTouchX - startTouchX > 50) {
            // Swipe right -> Previous
            document.getElementById('prevBtn').click();
        }
    });

    // Initialize the carousel if products exist
    if (products && products.length > 0) {
        changeImage(0); // Load the first product initially
    }

    // Add event listener to close modal when clicking outside the image
    document.getElementById('imageModal')?.addEventListener('click', (event) => {
        const modal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');

        // Check if the click is outside the image
        if (!modalImage.contains(event.target)) {
            closeModal();
        }
    });
</script>
{% endblock %}